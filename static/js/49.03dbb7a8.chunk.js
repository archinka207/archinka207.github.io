"use strict";(self.webpackChunktwentythree=self.webpackChunktwentythree||[]).push([[49],{1796:(e,t,r)=>{r.d(t,{CX:()=>d,HR:()=>i,Ij:()=>n,R7:()=>l,Tu:()=>s,Zm:()=>o,sS:()=>c});var a=r(2162);const s=async e=>{try{return(await a.A.post("/chats",e)).data}catch(r){var t;throw console.error("Error creating new chat:",(null===(t=r.response)||void 0===t?void 0:t.data)||r.message),r}},n=async e=>{try{return(await a.A.post("/chats/join/".concat(e))).data}catch(r){var t;throw console.error("Error joining chat for interest ID ".concat(e,":"),(null===(t=r.response)||void 0===t?void 0:t.data)||r.message),r}},c=async()=>{try{return(await a.A.get("/chats/current")).data}catch(t){var e;if(t.response&&(404===t.response.status||204===t.response.status))return null;throw console.error("Error fetching current chat:",(null===(e=t.response)||void 0===e?void 0:e.data)||t.message),t}},i=async e=>{try{return(await a.A.get("/chats/".concat(e))).data}catch(r){var t;throw console.error("Error fetching details for chat ID ".concat(e,":"),(null===(t=r.response)||void 0===t?void 0:t.data)||r.message),r}},o=async e=>{try{return(await a.A.get("/chats/".concat(e,"/messages"))).data}catch(r){var t;return console.warn("Failed to fetch initial messages for chat ".concat(e," via HTTP. This endpoint might not be implemented on the backend. Chat will rely on WebSocket for new messages."),(null===(t=r.response)||void 0===t?void 0:t.data)||r.message),[]}},l=async(e,t)=>{const r=new FormData;r.append("file",t);try{return(await a.A.post("/chats/".concat(e,"/messages/image"),r,{})).data}catch(n){var s;throw console.error("Error uploading image for chat ".concat(e,":"),(null===(s=n.response)||void 0===s?void 0:s.data)||n.message),n}},d=async e=>{try{return(await a.A.post("/chats/".concat(e,"/leave"))).data}catch(r){var t;throw console.error("Error leaving chat ".concat(e,":"),(null===(t=r.response)||void 0===t?void 0:t.data)||r.message),r}}},8049:(e,t,r)=>{r.r(t),r.d(t,{default:()=>O});var a=r(2555),s=r(5043),n=r(3519),c=r(1719),i=r(4282),o=r(1072),l=r(8602),d=r(4063),u=r(3260),m=r(342),h=r(1266),g=r(5081),p=r.n(g),v=r(2223),x=r(3637),f=r(8954),b=r(353),j=r(4648),y=r(579);const A=e=>{let{messages:t,currentUserNickname:r,currentUserId:a}=e;const n=(0,s.useRef)(null);return(0,s.useEffect)((()=>{var e;null===(e=n.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}),[t]),t&&0!==t.length?(0,y.jsxs)(v.A,{variant:"flush",className:"p-0",children:[" ",t.map(((e,t)=>{const s=r&&e.senderNickname===r||a&&e.senderId===a,n=(0,b.ak)(e.sentAt);return(0,y.jsx)(v.A.Item,{className:"d-flex flex-column ".concat(s?"align-items-end":"align-items-start"," mb-3 border-0 bg-transparent"),children:(0,y.jsxs)("div",{className:"message-bubble shadow-sm ".concat(s?"sent":"received"),children:[!s&&(0,y.jsxs)("div",{className:"message-sender d-flex align-items-center",children:[(0,y.jsx)(x.A,{src:(0,b.m_)(e.senderProfilePictureUrl)||j,alt:e.senderNickname,roundedCircle:!0,width:24,height:24,className:"me-2",onError:e=>{e.target.onerror=null,e.target.src=j}}),(0,y.jsx)("span",{children:e.senderNickname||"Unknown User"})]}),"TEXT"===e.messageType&&e.contentText&&(0,y.jsx)("p",{className:"mb-0",children:e.contentText}),"IMAGE"===e.messageType&&e.contentImageUrl&&(0,y.jsxs)(f.A,{className:"mb-1 mt-1",style:{maxWidth:"250px",cursor:"pointer"},onClick:()=>window.open((0,b.m_)(e.contentImageUrl),"_blank"),children:[(0,y.jsx)(f.A.Image,{src:(0,b.m_)(e.contentImageUrl),alt:"Chat attachment",fluid:!0,rounded:!0}),e.contentText&&(0,y.jsx)(f.A.Caption,{className:"small ".concat(s?"text-white-75":"text-muted"),children:e.contentText})]}),(0,y.jsx)("div",{className:"message-time text-end ".concat(s?"sent":"received"),children:n})]})},e.id||"msg-".concat(t))})),(0,y.jsx)("div",{ref:n})]}):(0,y.jsx)("p",{className:"text-center text-muted mt-4",children:"No messages yet. Start the conversation!"})};var N=r(5460),w=r(7994),S=r(7417),I=r(2138),k=r(1796);const T=e=>{let{onSendMessage:t,chatId:r,chatIsActive:a}=e;const[n,o]=(0,s.useState)(""),[l,d]=(0,s.useState)(null),[u,m]=(0,s.useState)(null),[h,g]=(0,s.useState)(!1),[p,v]=(0,s.useState)(""),f=(0,s.useRef)(null);return a?(0,y.jsxs)("div",{className:"message-input-area p-2 border-top bg-light",children:[p&&(0,y.jsx)(c.A,{variant:"danger",size:"sm",className:"mb-2 py-1",onClose:()=>v(""),dismissible:!0,children:p}),u&&(0,y.jsxs)("div",{className:"mb-2 position-relative",style:{maxWidth:"150px"},children:[(0,y.jsx)(x.A,{src:u,thumbnail:!0,fluid:!0}),(0,y.jsx)(i.A,{variant:"danger",size:"sm",onClick:()=>{d(null),m(null),f.current&&(f.current.value=""),v("")},disabled:h,className:"position-absolute top-0 end-0 m-1",style:{lineHeight:"0.8",padding:"0.2rem 0.4rem"},"aria-label":"Remove image",children:"\xd7"})]}),(0,y.jsx)(N.A,{onSubmit:e=>{e.preventDefault(),n.trim()&&(t(n.trim(),"TEXT",null),o(""),v(""))},children:(0,y.jsxs)(w.A,{children:[(0,y.jsx)(N.A.Control,{type:"file",id:"chatImageUploadInput",accept:"image/png, image/jpeg, image/gif",onChange:e=>{if(e.target.files&&e.target.files[0]){const t=e.target.files[0];if(!t.type.startsWith("image/"))return v("Please select an image file (png, jpg, gif)."),d(null),m(null),void(f.current&&(f.current.value=""));if(t.size>10485760)return v("File is too large. Max 10MB allowed."),d(null),m(null),void(f.current&&(f.current.value=""));d(t),m(URL.createObjectURL(t)),v("")}},ref:f,style:{display:"none"},"aria-label":"Upload image file",disabled:h}),(0,y.jsxs)(i.A,{variant:"outline-secondary",onClick:()=>{var e;null===(e=f.current)||void 0===e||e.click()},disabled:h,title:"Attach image",children:[(0,y.jsx)(I.Mqx,{})," "]}),(0,y.jsx)(N.A.Control,{type:"text",placeholder:"Type your message...",value:n,onChange:e=>o(e.target.value),"aria-label":"Message text",disabled:h||!!l,autoFocus:!0}),l?(0,y.jsx)(i.A,{variant:"success",onClick:async()=>{if(l&&r){g(!0),v("");try{const e=await(0,k.R7)(r,l);if(!e||!e.contentImageUrl)throw new Error("Image URL was not returned from the server after upload.");t(e.contentText,"IMAGE",e.contentImageUrl),d(null),m(null),f.current&&(f.current.value="")}catch(s){var e,a;console.error("Failed to upload and send image:",s),v((null===(e=s.response)||void 0===e||null===(a=e.data)||void 0===a?void 0:a.message)||"Failed to process image. Please try again.")}finally{g(!1)}}else v("Please select an image file first.")},disabled:h||!l,children:h?(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(S.A,{as:"span",animation:"border",size:"sm",role:"status","aria-hidden":"true"}),(0,y.jsx)("span",{className:"visually-hidden",children:"Uploading..."})]}):(0,y.jsx)(I.qYP,{})}):(0,y.jsxs)(i.A,{variant:"primary",type:"submit",disabled:!n.trim()||h,children:[(0,y.jsx)(I.qYP,{})," "]})]})})]}):null};var C=r(8628);const E=e=>{let{messages:t,currentUserNickname:r,currentUserId:a,onSendMessage:s,chatId:n,chatIsActive:c}=e;return(0,y.jsxs)(C.A,{className:"h-100 d-flex flex-column shadow-sm",children:[(0,y.jsxs)(C.A.Body,{className:"flex-grow-1 overflow-auto p-0 message-list-container",children:[" ",(0,y.jsx)(A,{messages:t,currentUserNickname:r,currentUserId:a})]}),c&&(0,y.jsxs)("div",{className:"message-input-form",children:[" ",(0,y.jsx)(T,{onSendMessage:s,chatId:n,chatIsActive:c})]}),!c&&(0,y.jsx)(C.A.Footer,{className:"text-center text-muted p-3",children:"This chat has ended. You can no longer send messages."})]})},U=e=>{let{participants:t,currentUserId:r}=e;return t&&0!==t.length?(0,y.jsxs)("div",{className:"h-100 d-flex flex-column",children:[" ",(0,y.jsxs)("h5",{className:"mb-2 text-center p-2 bg-light border-bottom",children:["Participants ",(0,y.jsx)(d.A,{pill:!0,bg:"secondary",children:t.length})]}),(0,y.jsxs)(v.A,{variant:"flush",className:"flex-grow-1 overflow-auto",children:[" ",t.map((e=>(0,y.jsxs)(v.A.Item,{className:"d-flex align-items-center p-2 border-0",children:[(0,y.jsx)(x.A,{src:(0,b.m_)(e.profilePictureUrl)||j,alt:e.nickname,roundedCircle:!0,width:32,height:32,className:"me-2 border",onError:e=>{e.target.onerror=null,e.target.src=j}}),(0,y.jsxs)("span",{className:"flex-grow-1 text-truncate",title:e.nickname,children:[" ",e.nickname]}),e.userId===r&&(0,y.jsx)(d.A,{pill:!0,bg:"success",text:"white",className:"ms-auto",children:"You"})]},e.userId)))]})]}):(0,y.jsx)("p",{className:"text-muted p-3 text-center",children:"No participants yet."})};var M=r(4653),P=r(2448);const R=e=>{let{expiryTimestamp:t,onChatExpired:r}=e;const a=(0,s.useMemo)((()=>{if(!t)return null;try{return(0,M.H)(t)}catch(e){return console.error("Invalid expiry timestamp provided to ChatTimer:",t,e),null}}),[t]),n=(0,s.useCallback)((()=>{if(!a)return null;const e=(0,P.O)(a,new Date);return e<=0?{total:0,hours:0,minutes:0,seconds:0}:{total:e,hours:Math.floor(e/3600),minutes:Math.floor(e%3600/60),seconds:Math.floor(e%60)}}),[a]),[c,i]=(0,s.useState)(n());if((0,s.useEffect)((()=>{if(!a||c&&c.total<=0)return void(c&&c.total<=0&&r&&"function"===typeof r&&r());const e=setInterval((()=>{i(n())}),1e3);return()=>clearInterval(e)}),[c,a,n,r]),!c||!t)return null;if(c.total<=0)return(0,y.jsx)(d.A,{bg:"danger",children:"Chat Expired"});const o=String(c.hours).padStart(2,"0"),l=String(c.minutes).padStart(2,"0"),u=String(c.seconds).padStart(2,"0");return(0,y.jsxs)(d.A,{bg:"warning",text:"dark",pill:!0,className:"p-2",children:["Time left: ",o,":",l,":",u]})};var F=r(5594);const O=()=>{const{currentUser:e,token:t,logout:r}=(0,m.A)(),g=(0,u.Zp)(),v=(0,u.zy)(),{chatId:x}=(0,u.g)(),[f,b]=(0,s.useState)(null),[j,A]=(0,s.useState)([]),[N,w]=(0,s.useState)(""),[S,I]=(0,s.useState)(!0),[T,C]=(0,s.useState)(!1),[M,P]=(0,s.useState)(!1),O=(0,s.useRef)(null),D=(0,s.useRef)(!1),W=(0,s.useRef)(g),z=(0,s.useRef)(v);(0,s.useEffect)((()=>{W.current=g}),[g]),(0,s.useEffect)((()=>{z.current=v}),[v]);const H=(0,s.useCallback)((async()=>{if(e){I(!0),w(""),D.current=!1;try{let e;if(e=x?await(0,k.HR)(x):await(0,k.sS)(),!e||!e.active)return w(e&&!e.active?"Your chat has expired or is no longer active.":"No active chat found."),b(null),void setTimeout((()=>W.current("/")),3e3);b(e);const t=await(0,k.Zm)(e.id);A(t||[])}catch(a){var t,r;console.error("Failed to fetch chat data:",a),w((null===(t=a.response)||void 0===t||null===(r=t.data)||void 0===r?void 0:r.message)||"Failed to load chat data."),b(null)}finally{I(!1)}}else W.current("/login",{state:{from:{pathname:"/chat".concat(x?"/".concat(x):"")}}})}),[e,x]);(0,s.useEffect)((()=>{H()}),[H]),(0,s.useEffect)((()=>{if(!f||!f.active||!t||D.current)return void(O.current&&O.current.active&&O.current.deactivate());if(O.current&&O.current.active)return;C(!0);const e=new h.K({brokerURL:"https://brilliant-liberation-production.up.railway.app/ws".replace("http","ws"),connectHeaders:{Authorization:"Bearer ".concat(t)},webSocketFactory:()=>new(p())("https://brilliant-liberation-production.up.railway.app/ws"),debug:e=>console.log("STOMP DEBUG: "+e),reconnectDelay:5e3,heartbeatIncoming:4e3,heartbeatOutgoing:4e3});return e.onConnect=t=>{C(!1),P(!0),console.log("STOMP: Connected to WebSocket:",t),e.subscribe("/topic/chat/".concat(f.id),(e=>{try{const t=JSON.parse(e.body);A((e=>[...e,t]))}catch(t){console.error("STOMP: Error parsing message body:",t,e.body)}})),e.subscribe("/user/queue/errors",(e=>{console.error("STOMP: Received error from server via WebSocket:",e.body),w("Chat Error: ".concat(e.body))}))},e.onStompError=e=>{C(!1),P(!1);const t=e.headers.message||"Broker error";console.error("STOMP: Broker reported error: "+t),console.error("STOMP: Additional details: "+e.body),w("WebSocket connection error: "+t),(null!==t&&void 0!==t&&t.includes("AccessDeniedException")||null!==t&&void 0!==t&&t.includes("401"))&&(r(),W.current("/login",{state:{from:z.current,error:"Session expired or invalid."},replace:!0}))},e.onWebSocketError=e=>{C(!1),P(!1),console.error("STOMP: WebSocket transport error:",e),D.current||w("WebSocket connection lost. Attempting to reconnect...")},e.onDisconnect=()=>{C(!1),P(!1),console.log("STOMP: Disconnected from WebSocket")},O.current=e,e.activate(),()=>{O.current&&O.current.active&&(O.current.deactivate(),O.current=null,P(!1))}}),[f,t,r]);const L=(0,s.useCallback)((()=>{w("This chat has expired."),b((e=>e?(0,a.A)((0,a.A)({},e),{},{active:!1}):null)),D.current=!0,O.current&&O.current.active&&O.current.deactivate()}),[]);return S?(0,y.jsx)(F.Y,{message:"Loading chat..."}):N&&!f?(0,y.jsx)(n.A,{className:"mt-5 text-center",children:(0,y.jsxs)(c.A,{variant:"danger",children:[(0,y.jsx)("h4",{children:"Error Loading Chat"}),(0,y.jsx)("p",{children:N}),(0,y.jsx)(i.A,{as:u.N_,to:"/",variant:"primary",children:"Go to Homepage"})]})}):f?(0,y.jsxs)(n.A,{fluid:!0,className:"d-flex flex-column p-0",style:{height:"calc(100vh - 56px - 1rem)"},children:[N&&!f.active&&(0,y.jsx)(c.A,{variant:"danger",className:"m-2",onClose:()=>w(""),dismissible:!0,children:N}),T&&(0,y.jsx)(c.A,{variant:"info",className:"m-2 text-center",children:"Connecting to chat server..."}),!M&&f.active&&!T&&(0,y.jsx)(c.A,{variant:"warning",className:"m-2 text-center",children:"Disconnected. Attempting to reconnect..."}),(0,y.jsxs)(o.A,{className:"g-0 p-2 align-items-center border-bottom bg-light sticky-top",style:{top:"56px",zIndex:1e3},children:[(0,y.jsxs)(l.A,{children:[(0,y.jsx)("h4",{className:"mb-0 text-truncate",title:f.chatName,children:f.chatName}),(0,y.jsxs)("small",{className:"text-muted",children:["Interest: ",f.primaryInterestName]})]}),(0,y.jsxs)(l.A,{md:"auto",className:"text-center mx-2",children:[f.expiresAt&&f.active&&(0,y.jsx)(R,{expiryTimestamp:f.expiresAt,onChatExpired:L}),!f.active&&(0,y.jsx)(d.A,{bg:"secondary",children:"Chat Inactive"})]}),(0,y.jsx)(l.A,{md:"auto",children:(0,y.jsx)(i.A,{variant:"outline-danger",size:"sm",onClick:async()=>{if(f){I(!0);try{await(0,k.CX)(f.id),O.current&&O.current.active&&O.current.deactivate(),W.current("/")}catch(r){var e,t;console.error("Failed to leave chat:",r),w((null===(e=r.response)||void 0===e||null===(t=e.data)||void 0===t?void 0:t.message)||"Error leaving chat.")}finally{I(!1)}}},disabled:S,children:"Leave Chat"})})]}),(0,y.jsxs)(o.A,{className:"g-0 flex-grow-1",style:{overflow:"hidden"},children:[(0,y.jsx)(l.A,{xs:12,md:8,lg:9,className:"d-flex flex-column p-0 border-end",children:(0,y.jsx)(E,{messages:j,currentUserNickname:null===e||void 0===e?void 0:e.nickname,currentUserId:null===e||void 0===e?void 0:e.id,onSendMessage:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"TEXT",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(O.current&&O.current.connected&&f&&f.active){const s={messageType:t,contentText:"TEXT"===t?e:null,contentImageUrl:"IMAGE"===t?r:null};try{O.current.publish({destination:"/app/chat/".concat(f.id,"/send"),body:JSON.stringify(s)})}catch(a){console.error("STOMP: Failed to publish message:",a),w("Failed to send message. Connection issue?")}}else w("Not connected to chat or chat is inactive.")},chatId:f.id,chatIsActive:f.active&&M})}),(0,y.jsx)(l.A,{md:4,lg:3,className:"d-none d-md-block participant-list-col h-100 overflow-auto bg-light",children:(0,y.jsx)(U,{participants:f.participants||[],currentUserId:null===e||void 0===e?void 0:e.id})})]}),(0,y.jsx)(o.A,{className:"g-0 d-md-none mt-2 border-top",children:(0,y.jsx)(l.A,{xs:12,className:"participant-list-col-mobile p-2 bg-light",style:{maxHeight:"200px",overflowY:"auto"},children:(0,y.jsx)(U,{participants:f.participants||[],currentUserId:null===e||void 0===e?void 0:e.id})})})]}):(0,y.jsx)(n.A,{className:"mt-5 text-center",children:(0,y.jsxs)(c.A,{variant:"info",children:["No active chat found.",(0,y.jsx)("div",{className:"mt-3",children:(0,y.jsx)(i.A,{as:u.N_,to:"/",variant:"outline-primary",children:"Find or Create a New Chat"})})]})})}}}]);
//# sourceMappingURL=49.03dbb7a8.chunk.js.map